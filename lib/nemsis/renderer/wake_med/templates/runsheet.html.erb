
<!--
    NOTE: The later Specialty Tables began to use the latest incarnation of table generation row().

    TODO: consider refactoring the other tables to use the simple syntax.
-->

<%
   @fancy_html ||= false

   def start_table(title="", options="")
     if @fancy_html
       text = "<table #{(options.empty?) ? '' : options} #{(title.empty?) ? '' : "title='#{title}'"}>"
     else
       text = "<table border='1' cellspacing='0' width='700' #{(title.empty?) ? '' : "title='#{title}'"}>"
     end
   end

   def borderless_table
     if @fancy_html
       text = "<table class='no-border'>"
     else
       text = "<table border='0' cellspacing='0' width='700'>"
     end
   end

   def borderless_cell(label, value)
     if @fancy_html
       text = "<td class='no-border'><b>#{label}</b></td><td class='no-border'>#{value}</td>"
     else
       text = "<td border='0'><font size='2'><b>#{label}</b></font><td border='0'><font size='2'>#{value}</font></td>"
     end
   end

   # Create a grid of Label/Value pairs using the name from the YML file as the label
   def row(*fields)
     text = start_row
     fields.each do |field|
       #puts "Field = #{field}"
       if field.empty?
         text += cell("")
         text += cell("")
       else
         element = @parser.get(field)
         text += labeled_cell(element[:name], @parser.send(field))
       end
     end
     text += '</tr>'
   end

   # Specialized row version for the Obstetrical table
   def ob_row(field1, field2, field3, field4)
     text = start_row
     element = @parser.get(field1)
     text += labeled_cell(element[:name], @parser.send(field1))
     if field2.empty?
       text += cell("")
       text += cell("")
     else
       element = @parser.get(field2)
       text += labeled_cell(element[:name], @parser.send(field2))
     end
     element = @parser.get(field3)
     text += labeled_cell(element[:name], @parser.index(field3))
     element = @parser.get(field4)
     text += cell @parser.index(field4)

     text += '</tr>'
   end

   def start_row(options="")
     if @fancy_html
       text = "<tr #{(options.empty?) ? '' : options}>"
     else
       text = "<tr>"
     end
   end

   def label(label, colspan=0)
     if @fancy_html
       text = "    <td class='label' #{(colspan > 0) ? "colspan='#{colspan}'" : '' } >#{label}</td>"
     else
       text = "    <td #{(colspan > 0) ? "colspan='#{colspan}'" : '' } ><font size='2'><b>#{label}</b></font></td>"
     end
     text
   end

   def label_with_style(style, label, rowspan=0)
     if @fancy_html
       text = "<td class='#{style}' #{(rowspan > 0) ? "rowspan='#{rowspan}'" : '' }>#{label}</td>"
     else
       text = case style
                when 'label'
                  "<td #{(rowspan > 0) ? "rowspan='#{rowspan}'" : '' }><font size='2'><b>#{label}</b></font></td>"
                when 'label-medium'
                  "<td width='25%' #{(rowspan > 0) ? "rowspan='#{rowspan}'" : '' }><font size='2'><b>#{label}</b></font></td>"
                when 'label-narrow'
                  "<td width='10%' #{(rowspan > 0) ? "rowspan='#{rowspan}'" : '' }><font size='2'><b>#{label}</b></font></td>"
                else
                  "<td #{(rowspan > 0) ? "rowspan='#{rowspan}'" : '' }><font size='2'><b>#{label}</b></font></td>"
              end
       text
     end
   end

   def tall_label(label, rowspan=0)
     label_with_style('label', label, rowspan)
   end

   def label_top(label, colspan=0)
     if @fancy_html
       text = "    <td class='label-top' #{(colspan > 0) ? "colspan='#{colspan}'" : '' }>#{label}</td>"
     else
       text = "    <td #{(colspan > 0) ? "colspan='#{colspan}'" : '' }><font size='2'><b>#{label}</b></font></td>"
     end
     text
   end

   def heading(label, colspan=0)
     if @fancy_html
       text = "    <th #{(colspan > 0) ? "colspan='#{colspan}'" : '' }>#{label}</th>"
     else
       text = "    <th #{(colspan > 0) ? "colspan='#{colspan}'" : '' }><font color='blue' size='3'>#{label}</font></th>"
     end
     text
   end

   def cell(value, colspan=0, rowspan=0)
     if @fancy_html
       text = "    <td class='value' #{(colspan > 0) ? "colspan='#{colspan}'" : '' } #{(rowspan > 0) ? "rowspan='#{rowspan}'" : '' }>#{value}</td>"
     else
       text = "    <td #{(colspan > 0) ? "colspan='#{colspan}'" : '' } #{(rowspan > 0) ? "rowspan='#{rowspan}'" : '' }><font size='2'>#{value}</font></td>"
     end
     text
   end

   def labeled_cell_with_style(style, label, value, colspan=0)
     text = "#{label_with_style(style, label)} #{cell(value, colspan)}"
   end

   def labeled_cell(label, value, colspan=0)
     labeled_cell_with_style('label', label, value, colspan)
   end

   def labeled_cell_medium(label, value, colspan=0)
     labeled_cell_with_style('label-medium', label, value, colspan)
   end

   def labeled_cell_narrow(label, value, colspan=0)
     labeled_cell_with_style('label-narrow', label, value, colspan)
   end

   # Return a set of rows
   def list(the_hash)
     return if the_hash.nil? || the_hash.empty?
     text = ""
     the_hash.each do |k,v|
       text += "<tr>#{labeled_cell(k,v)}</tr>\n"
     end
     text
   end

   # Helper method to make it easy to display only those delays that are present
   def list_of_delays
     list = {}
     list.merge!(get_delay("Dispatch", @parser.E02_06))
     list.merge!(get_delay("Response", @parser.E02_07))
     list.merge!(get_delay("Scene", @parser.E02_08))
     list.merge!(get_delay("Transport", @parser.E02_09))
     list.merge!(get_delay("Turn-Around", @parser.E02_10))
     list
   end

   def get_delay(type, value)
     return {} if value.empty?
     delay = {type => value}
     delay
   end

   # Return a list of ;-separated items
   def concat_list(items)
     items.select { |v| !v.strip!.nil? }.join('; ')
   end

%>

<% if @fancy_html %>
    <HEAD>
      <STYLE type="text/css">
          <!--

              /*p, h4, table {font-family: "Lucida Grande", verdana, arial, helvetica, sans-serif;}*/
              /*p, h4, table {font-family: Tahoma, Geneva, sans-serif}*/
          p, h4, table {
              font-family: "Trebuchet MS", Helvetica, sans-serif
          }

          p {
              font-size: small;
          }

          H4 {
              color: black
          }

              /* Each section can be a table */
          table, tbody, tr {
              border: 1px;
              border-style: solid;
              border-color: black;
              border-spacing: 0px;
              width: 700;
              color: black;
              margin: 0;
              padding: 1px;
          }

              /* The section can have a bold heading row */
          th {
              color: yellow;
              background-color: #6495ed;
              font-size: medium;
              border-color: black;
              border-style: solid;
              border-width: 1px;
          }

              /* Default table cell for values */
          td {
              border: 1px;
              border-style: solid;
              border-color: #737373;
              font-size: small;
              padding: 2px;
          }

              /* Default label cell */
          td.label {
              text-align: left;
              font-weight: bold;
              background-color: #dcdcdc;
          }

              /* Label on top of column */
          td.label-top {
              text-align: center;
              font-weight: bold;
              background-color: #dcdcdc;
          }

              /* Narrow label cell */
          td.label-narrow {
              text-align: left;
              font-weight: bold;
              background-color: #dcdcdc;
              width: 10%;
          }

              /* Medium label cell */
          td.label-medium {
              text-align: left;
              font-weight: bold;
              background-color: #dcdcdc;
              width: 25%;
          }
          .no-border {
              border: 1px;
              border-style: none;
              border-color: red;
              border-spacing: 0px;
          }

          -->
      </STYLE>
    </HEAD>
<% end %>

<h4>Wake County EMS System - Patient Care Record</h4>
<p>
  <%= borderless_table %>
      <%= start_row %>
        <%= borderless_cell "Name:", "#{@parser.E06_01}, #{@parser.E06_02}" %>
        <%= borderless_cell "Incident #:", @parser.E02_02 %>
        <%= borderless_cell "Date:", @parser.parse_time('E05_03', true) %>
      </tr>
    </table>
</p>
<%= start_table "Patient Information" %>
  <thead>
  <%= start_row %>
    <%= heading "Patient Information", 14 %>
  </tr>
  </thead>
  <tbody>
  <%= start_row %>
    <%= labeled_cell "Last", @parser.E06_01 %>
    <%= labeled_cell "First", @parser.E06_02 %>
    <%= labeled_cell "Middle", @parser.E06_03 %>
    <%= labeled_cell "DOB", @parser.E06_16 %>
    <%= labeled_cell "Gender", @parser.E06_11 %>
    <%= labeled_cell "Weight", "#{@parser.E16_01} kg" %>
    <%= labeled_cell "SSN", @parser.E06_10 %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "Address", @parser.E06_04 %>
    <%= labeled_cell "Address 2", "E23_09 field TBD" %>
    <%= labeled_cell "City", @parser.E06_05 %>
    <%= labeled_cell "State", @parser.parse_state('E06_07') %>
    <%= labeled_cell "Zip", @parser.E06_08 %>
    <%= labeled_cell "Country", @parser.E06_09 %>
    <%= labeled_cell "Tel", @parser.E06_17 %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "Advanced Directive", @parser.E12_07, 13 %>
  </tr>
  </tbody>
</table>
<br>
<%= start_table "Clinical Impression" %>
  <thead>
  <%= start_row %>
    <%= heading "Clinical Impression", 8 %>
  </tr>
  </thead>
  <tbody>
  <%= start_row %>
    <%= labeled_cell "Primary Impression", @parser.E09_15 %>
    <%= labeled_cell "Chief Complaint", @parser.E09_05 %>
    <%= labeled_cell "Injury", (@parser.concat 'E10_01', 'E10_02', 'E10_03') %>
    <%= labeled_cell "Barriers of Care", @parser.E12_01 %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "Secondary Impression", @parser.E09_16 %>
    <%= labeled_cell "Duration", (@parser.concat 'E09_06', 'E09_07') %>
    <%= labeled_cell "Medical/ Trauma", @parser.parse_value_of('MedicalTrauma') %>
    <%= labeled_cell "Alcohol/ Drugs", @parser.E12_19 %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "Signs &amp; Symptoms", (@parser.concat 'E09_13', 'E09_14'), 7 %>
  </tr>
  </tbody>
</table>
<br>
<%= start_table "Medication/Allergies/History" %>
  <thead>
  <%= start_row %>
    <%= heading "Medication/Allergies/History", 16 %>
  </tr>
  </thead>
  <tbody>
  <%= start_row %>
    <%= labeled_cell_medium "Medications", (@parser.concat 'E12_14', 'E12_15', 'E12_16'), 15 %>
  </tr>
  <%= start_row %>
    <%= labeled_cell_medium "Allergies", (@parser.concat 'E12_08', 'E12_09'), 15 %>
  </tr>
  <%= start_row %>
    <%= labeled_cell_medium "History", @parser.E12_10, 15 %>
  </tr>
  </tbody>
</table>
<br>

<%= start_table "Vital Signs" %>

  <%= start_row %>
    <%= heading "Vital Signs", 16 %>
  </tr>
  <%= start_row %>
    <%= label_top "Time" %>
    <%= label_top "AVPU" %>
    <%= label_top "Side" %>
    <%= label_top "POS" %>
    <%= label_top "BP" %>
    <%= label_top "Pulse" %>
    <%= label_top "RR" %>
    <%= label_top "SPO2" %>
    <%= label_top "ETCO2" %>
    <%= label_top "CO" %>
    <%= label_top "BG" %>
    <%= label_top "Temp" %>
    <%= label_top "Pain" %>
    <%= label_top "GCS" %>
    <%= label_top "RTS" %>
    <%= label_top "<b>PTS</b>" %>
  </tr>

  <% @parser.parse_cluster('E14').sort_by { |e14| Time.parse(e14.E14_01) rescue Time.now }.each do |e14| %>
      <%= start_row %>
        <%= cell (e14.parse_time('E14_01')) %>
        <%= cell (e14.E14_22) %>
        <%= cell (e14.E14_29) %>
        <%= cell (e14.E14_30) %>
        <%= cell ((e14.concat 'E14_04', 'E14_05', 'E14_06')) %>
        <%= cell ([(e14.E14_07 || e14.E14_08), e14.E14_10].compact.join(' ')) %>
        <%= cell ((e14.concat 'E14_11', 'E14_12')) %>
        <%= cell (e14.E14_09) %>
        <%= cell (e14.E14_13) %>
        <%= cell (e14.E14_31) %>
        <%= cell (e14.E14_14) %>
        <%= cell ((e14.concat 'E14_20', 'E14_21')) %>
        <%= cell (e14.E14_23) %>
        <%= cell (e14.E14_19) %>
        <%= cell (e14.E14_27) %>
        <%= cell (e14.E14_28) %>
      </tr>
  <% end %>

</table>
<br>

<%= start_table "ECG" %>
  <thead>
  <%= start_row %>
    <%= heading "ECG", 3 %>
  </tr>
  </thead>
  <%= start_row %>
    <%= label "Time" %>
    <%= label "3-Lead ECG" %>
    <%= label "12-Lead ECG" %>
  </tr>

  <% @parser.parse_cluster('E14').sort_by { |e14| Time.parse(e14.E14_01) rescue Time.now }.each do |e14| %>
      <%= start_row %>
        <%= cell (e14.parse_time('E14_01')) %>
        <%= cell (e14.E14_03) %>
        <%= cell (e14.E14_33) %>
      </tr>
  <% end %>
</table>
<br>

<%= start_table "Flow Chart" %>
  <thead>
  <%= start_row %>
    <%= heading "Flow Chart", 4 %>
  </tr>
  </thead>
  <%= start_row %>
    <%= label "Time" %>
    <%= label "Treatment" %>
    <%= label "Description" %>
    <%= label "Provider" %>
  </tr>

  <% @parser.parse_clusters('E18', 'E19').sort_by { |c| Time.parse(c.sub_element('01')) rescue Time.now }.each do |cluster| %>
      <%= start_row %>
        <td><%= Time.parse(cluster.sub_element('01')).strftime('%Y-%m-%d %H:%M') rescue nil %></td>
        <%= cell (cluster.sub_element('03')) %>
        <td>
          <p>
            <% if cluster.root_element_name == 'E18' %>
                <%= concat_list [(cluster.concat 'E18_05', 'E18_06'), cluster.E18_07, cluster.E18_08] %>
            <% elsif cluster.root_element_name == 'E19' %>
            <% end %>
          </p>
        </td>
        <td>E18_09 or E19_09 to be mapped to name</td>
      </tr>
  <% end %>
</table>
<br>

<% assessments = @parser.parse_assessments
   unless assessments.empty?
%>
    <%= start_table "Initial Assessment" %>
      <thead>
      <%= start_row %>
        <%= heading "Initial Assessment", 4 %>
      </tr>
      </thead>
      <tbody>
      <% assessments.each do |assessment| %>
          <%= start_row %>
            <%= label "Category" %>
            <%= label "Comments" %>
            <%= label "&nbsp;" %>
            <%= label "Abnormalities" %>
          </tr>
          <%= start_row %>
            <%= labeled_cell "Mental Status", (assessment.E16_25) %>
            <%= labeled_cell "Mental Status", (assessment.E16_23) %>
          </tr>
          <%= start_row %>
            <%= labeled_cell "Skin", (assessment.E16_26) %>
            <%= labeled_cell "Skin", (assessment.concat('E16_04', 'E15_01')) %>
          </tr>
          <%= start_row %>
            <%= tall_label "HEENT", 3 %>
            <%= cell assessment.E16_27, 1, 3 %>
            <%= labeled_cell "Head/Face", (assessment.concat('E16_05', 'E15_02', 'E15_03')) %>
          </tr>
          <%= start_row %>
            <%= labeled_cell "Eyes", (assessment.concat('E16_21', 'E16_22')) %>
          </tr>
          <%= start_row %>
            <%= labeled_cell "Neck", (assessment.E16_06) %>
          </tr>
          <%= start_row %>
            <%= tall_label "Chest", 3 %>
            <%= cell assessment.E16_28, 1, 3 %>
            <%= labeled_cell "Chest", (assessment.E15_05) %>
          </tr>
          <%= start_row %>
            <%= labeled_cell "Heart Sounds", (assessment.E16_08) %>
          </tr>
          <%= start_row %>
            <%= labeled_cell "Lung Sounds", (assessment.E16_07) %>
          </tr>
          <%= start_row %>
            <%= tall_label "Abdomen", 5 %>
            <%= cell assessment.E16_29, 1, 5 %>
            <%= labeled_cell "General", (assessment.concat('E16_13', 'E15_06')) %>
          </tr>
          <%= start_row %>
            <%= labeled_cell "Left Upper", (assessment.E16_09) %>
          </tr>
          <%= start_row %>
            <%= labeled_cell "Right Upper", (assessment.E16_11) %>
          </tr>
          <%= start_row %>
            <%= labeled_cell "Left Lower", (assessment.E16_10) %>
          </tr>
          <%= start_row %>
            <%= labeled_cell "Right Lower", (assessment.E16_12) %>
          </tr>
          <%= start_row %>
            <%= tall_label "Back", 3 %>
            <%= cell assessment.E16_30, 1, 3 %>
            <%= labeled_cell "Cervical", (assessment.E16_14) %>
          </tr>
          <%= start_row %>
            <%= labeled_cell "Thoracic", (assessment.E15_07) %>
          </tr>
          <%= start_row %>
            <%= labeled_cell "Lumbar/Sacral", (assessment.E16_16) %>
          </tr>
          <%= start_row %>
            <%= label "Pelvis/GU/GI" %>
            <%= cell (assessment.E16_31) %>
            <%= labeled_cell "Pelvis/GU/GI", (assessment.concat('E16_13', 'E15_09')) %>
          </tr>
          <%= start_row %>
            <%= tall_label "Extremities", 6 %>
            <%= cell assessment.E16_32, 1, 6 %>
            <%= labeled_cell "Left Arm", (assessment.E16_19) %>
          </tr>
          <%= start_row %>
            <%= labeled_cell "Right Arm", (assessment.E16_17) %>
          </tr>
          <%= start_row %>
            <%= labeled_cell "Left Leg", (assessment.E16_20) %>
          </tr>
          <%= start_row %>
            <%= labeled_cell "Right Leg", (assessment.E16_18) %>
          </tr>
          <%= start_row %>
            <%= labeled_cell "Pulse", "TBD" %>
          </tr>
          <%= start_row %>
            <%= labeled_cell "Capillary Refill", "TBD" %>
          </tr>
          <%= start_row %>
            <%= labeled_cell "Neurological", (assessment.E16_33) %>
            <%= labeled_cell "Neurological", (assessment.E16_24) %>
          </tr>
          <%= start_row %>
            <%= labeled_cell "Assessment Time", assessment.parse_time('E16_03', true), 3 %>
          </tr>
          </tbody>
          </table>
          <br>
      <% end %>
<% end %>

<% unless @parser.E13_01.empty? %>
<%= start_table "Narrative" %>
  <thead>
  <%= start_row %>
    <%= heading "Narrative" %><%= cell (@parser.E13_01) %>
  </tr>
  </thead>
</table>
<br>
<% end %>

  <%= start_table "Specialty Patient &mdash; ACS" %>
    <thead>
    <%= start_row%>
      <%= heading "Specialty Patient &mdash; ACS", 6 %>
    </tr>
    </thead>
    <tbody>
    <%= start_row %>
      <%= labeled_cell_narrow "12 Lead", @parser.E28_27 %>
      <%=  cell @parser.parse_time('E28_28', true), 4 %>
    </tr>
    <%= start_row %>
      <%= labeled_cell_narrow "Lead I:", @parser.E28_07 %>
      <%= labeled_cell_narrow "V1:", @parser.E28_13 %>
      <%= labeled_cell_narrow "V4R:", @parser.E28_19 %>
    </tr>
    <%= start_row %>
      <%= labeled_cell_narrow "Lead II:", @parser.E28_08 %>
      <%= labeled_cell_narrow "V2:", @parser.E28_14 %>
      <%= labeled_cell_narrow "V5R:", @parser.E28_20 %>
    </tr>
    <%= start_row %>
      <%= labeled_cell_narrow "Lead III:", @parser.E28_09 %>
      <%= labeled_cell_narrow "V3:", @parser.E28_15 %>
      <%= labeled_cell_narrow "V6R:", @parser.E28_21 %>
    </tr>
    <%= start_row %>
      <%= labeled_cell_narrow "AVL:", @parser.E28_11 %>
      <%= labeled_cell_narrow "V4:", @parser.E28_16 %>
      <%= labeled_cell_narrow "V7:", @parser.E28_22 %>
    </tr>
    <%= start_row %>
      <%= labeled_cell_narrow "AVR:", @parser.E28_10 %>
      <%= labeled_cell_narrow "V5:", @parser.E28_17 %>
      <%= labeled_cell_narrow "V8:", @parser.E28_23 %>
    </tr>
    <%= start_row %>
      <%= labeled_cell_narrow "AVF:", @parser.E28_12 %>
      <%= labeled_cell_narrow "V6:", @parser.E28_18 %>
      <%= labeled_cell_narrow "V9:", @parser.E28_24 %>
    </tr>
    <%= start_row %>
      <%= cell "" %>
      <%= label_top "OPQRST:", 5 %>
    </tr>
    <%= start_row %>
      <%= labeled_cell_narrow "Onset:", @parser.E28_01 %>
      <%= labeled_cell_narrow "Provoke:", @parser.E28_02 %>
      <%= labeled_cell_narrow "Quality:", @parser.E28_03 %>
    </tr>
    <%= start_row %>
      <%= labeled_cell_narrow "Radiation:", @parser.E28_04 %>
      <%= labeled_cell_narrow "Severity:", @parser.E28_05 %>
      <%= labeled_cell_narrow "Time:", @parser.E28_06 %>
    </tr>
    <%= start_row %>
    <%= labeled_cell_narrow "Inclusion Criteria:", @parser.E28_25, 2 %>
    <%= labeled_cell_narrow "Exclusion Criteria:", @parser.E28_26, 2 %>
    </tr>
    </tbody>
  </table>
  <br>

  <%= start_table "Specialty Patient &mdash; Advanced Airway" %>
    <thead>
    <%= start_row %>
      <%= heading "Specialty Patient &mdash; Advanced Airway", 4 %>
    </tr>
    <%= start_row %>
      <%= labeled_cell "Mallampati Class", @parser.E25_01 %>
      <%= labeled_cell "Airway Grading", @parser.E25_02 %>
    </tr>
    </thead>
    <tbody>
    <%= start_row %>
      <%= label "Indications" %>
      <%= label "Monitoring" %>
      <%= label "Rescue" %>
      <%= label "Reasons Failed Intubation" %>
    </tr>
    <%= start_row %>
      <%= val = @parser.E25_03
          val.is_a?(Array) ? val.join(', ') : val
          cell val
      %>
      <%= val = @parser.E25_04
          val.is_a?(Array) ? val.join(', ') : val
          cell val
      %>
      <%= val = @parser.E25_05
          val.is_a?(Array) ? val.join(', ') : val
          cell val
      %>
      <%= val = @parser.E25_06
          val.is_a?(Array) ? val.join(', ') : val
          cell val
      %>
    </tr>
    </tbody>
  </table>
<br>

<%= start_table "Specialty Patient &mdash; Burns" %>
    <thead>
    <%= start_row %>
      <%= heading "Specialty Patient &mdash; Burns", 8 %>
    </tr>
    </thead>
    <tbody>
    <%= start_row %>
      <%= labeled_cell_narrow "1st Degree", "#{@parser.E26_02}%" %>
      <%= labeled_cell_narrow "2nd Degree", "#{@parser.E26_03}%" %>
      <%= labeled_cell_narrow "3rd Degree", "#{@parser.E26_04}%" %>
      <%= labeled_cell_narrow "Total BSA",  "#{@parser.E26_01}%" %>
    </tr>
    </tbody>
</table>
<br>

<%= start_table "Specialty Patient &mdash; Stroke" %>
    <thead>
    <%= start_row %>
      <%= heading "Specialty Patient &mdash; Stroke", 10 %>
    </tr>
    </thead>
    <tbody>
    <%= start_row %>
        <%= labeled_cell_narrow "Onset", @parser.parse_time('E27_01') %>
        <%= labeled_cell_narrow "Screening Met", @parser.E27_02 %>
        <%= labeled_cell_narrow "Facial Droop", @parser.E27_03 %>
        <%= labeled_cell_narrow "Arm Drift",  @parser.E27_04 %>
        <%= labeled_cell_narrow "Speech",  @parser.E27_05 %>
    </tr>
    </tbody>
</table>
<br>

<%= start_table "SpecialtyPatientCPR" %>
    <thead>
    <%= start_row %>
      <%= heading "Specialty Patient &mdash; CPR", 4 %>
    </tr>
    </thead>
    <tbody>
    <%= start_row %>
    <%= labeled_cell_medium "Cardiac Arrest", @parser.E29_01 %>
    <%= labeled_cell_medium "Prearrival CPR Instructions", @parser.E29_20 %>
    </tr>
    <%= start_row %>
    <%= labeled_cell_medium "Cardiac Arrest Etiology", @parser.E29_02 %>
    <%= labeled_cell_medium "First Defibrillated By", @parser.E29_21 %>
    </tr>
    <%= start_row %>
    <%= labeled_cell_medium "Estimated Time of Arrest", @parser.E29_03 %>
    <%= labeled_cell_medium "Time of First Defib", @parser.E29_22 %>
    </tr>
    <%= start_row %>
    <%= labeled_cell_medium "Est Time Collapse to 911", @parser.E29_17 %>
    <%= labeled_cell_medium "Initial ECG Rhythm", @parser.E29_09 %>
    </tr>
    <%= start_row %>
    <%= labeled_cell_medium "Est Time Collapse to CPR", @parser.E29_18 %>
    <%= labeled_cell_medium "Rhythm at Destination", @parser.E29_11 %>
    </tr>
    <%= start_row %>
    <%= labeled_cell_medium "Arrest Witnessed By", @parser.E29_04 %>
    <%= labeled_cell_medium "Hypothermia", @parser.E29_23 %>
    </tr>
    <%= start_row %>
    <%= labeled_cell_medium "CPR Initiated By", @parser.E29_05 %>
    <%= labeled_cell_medium "End of Event", @parser.E29_22 %>
    </tr>
    <%= start_row %>
    <%= labeled_cell_medium "Time 1st CPR", @parser.E29_26 %>
    <%= labeled_cell_medium "ROSC", @parser.E29_10 %>
    </tr>
    <%= start_row %>
    <%= labeled_cell_medium "CPR Feedback", @parser.E29_27 %>
    <%= labeled_cell_medium "ROSC Time", @parser.E29_19 %>
    </tr>
    <%= start_row %>
    <%= labeled_cell_medium "ITD Used", @parser.E29_28 %>
    <%= labeled_cell_medium "ROSC Occurred", @parser.E29_29 %>
    </tr>
    <%= start_row %>
    <%= labeled_cell_medium "Applied AED", @parser.E29_06 %>
    <%= labeled_cell_medium "Resuscitation Discontinued", @parser.E29_12 %>
    </tr>
    <%= start_row %>
    <%= labeled_cell_medium "Applied By", @parser.E29_07 %>
    <%= labeled_cell_medium "Discontinued Reason", @parser.E29_13 %>
    </tr>
    <%= start_row %>
    <%= labeled_cell_medium "Defibrillated", @parser.E29_25 %>
    <%= labeled_cell_medium "Resuscitation Attempted", "#{@parser.E29_20} #{@parser.E29_30}" %>
    </tr>
    <%= start_row %>
      <%= heading "In-Field Pronouncement", 4 %>
    </tr>
    <tr>
      <%= labeled_cell_narrow "Expired",  @parser.E29_14 %>
      <%= cell "#{@parser.parse_time('E29_15') } #{@parser.E29_16}", 2 %>
    </tr>
    </tbody>
</table>
<br>

<%= start_table "SpecialtyPatientMVC" %>
    <thead>
    <%= start_row %>
      <%= heading "Specialty Patient &mdash; Motor Vehicle Collision", 4 %>
    </tr>
    </thead>
    <tbody>
    <%= row 'E31_01', 'E31_06' %>
    <%= row 'E31_02', 'E31_12' %>
    <%= row 'E31_03', 'E31_14' %>
    <%= row 'E31_04', 'E31_15' %>
    <%= row 'E31_05', 'E31_13' %>
    <%= row 'E31_07', 'E31_08' %>
    <%= row 'E31_09', 'E31_11' %>
    </tbody>
</table>
<br>

<%= start_table "Specialty Patient &mdash; Trauma Criteria" %>
    <thead>
    <%= start_row %>
      <%= heading "Specialty Patient &mdash; Trauma Criteria", 4 %>
    </tr>
    </thead>
    <tbody>
    <%= start_row %>
      <%= labeled_cell "Anatomic", @parser.E24_08 %>
      <%= labeled_cell "Trauma Activation", @parser.E24_01 %>
    </tr>
    <%= start_row %>
      <%= labeled_cell "Physiologic", @parser.E24_06 %>
      <%= labeled_cell "Time", @parser.parse_time('E24_02')%>
    </tr>
    <%= start_row %>
      <%= labeled_cell "Mechanical", @parser.E24_07 %>
      <%= labeled_cell "Date", @parser.parse_date('E24_02') %>
    </tr>
    <%= start_row %>
      <%= labeled_cell "Other Conditions", @parser.E24_05 %>
      <%= labeled_cell "Trauma Level", @parser.E24_04 %>
    </tr>
    <%= start_row %>
      <td></td>
      <td></td>
      <%= labeled_cell "Reason not Activated", @parser.E24_03 %>
    </tr>
    </tbody>
</table>
<br>

<%= start_table "SpecialtyPatientObstetrical" %>
    <thead>
    <%= start_row %>
      <%= heading "Specialty Patient &mdash; Obstetrical", 7 %>
    </tr>
    </thead>
    <tbody>
    <%= start_row %>
    <%= labeled_cell @parser.name('E32_01'), @parser.E32_01 %><%= labeled_cell @parser.name('E32_09'), @parser.E32_09 %><%= label "APGAR" %><%= label "1 Min" %><%= label "5 Min" %>
    </tr>
    <%= ob_row('E32_02', 'E32_10', 'E32_19', 'E32_25') %>
    <%= ob_row('E32_03', 'E32_11', 'E32_20', 'E32_26') %>
    <%= ob_row('E32_04', 'E32_12', 'E32_21', 'E32_27') %>
    <%= ob_row('E32_05', 'E32_13', 'E32_22', 'E32_28') %>
    <%= ob_row('E32_06', 'E32_14', 'E32_23', 'E32_29') %>
    <%= ob_row('E32_07',       '', 'E32_24', 'E32_30') %>
    <%= start_row %>
    <% high_risk_info = @parser.E32_08 %>
      <%= labeled_cell "High Risk Pregnancy", high_risk_info, 6 %>
    </tr>
    <%= start_row %>
    <%
       #complication_info = %w(E32_15 E32_16 E32_17 E32_18).collect {|e| el=@parser.get(e); (el[:value] =~ /yes/i) ? el[:name] : nil }.join('; ')
       names = []
       %w(E32_15 E32_16 E32_17 E32_18).each do |e|
         el = @parser.get(e)
         if el[:value] =~ /yes/i
           names << el[:name]
         end
       end
       complication_info = names.join('; ')
    %>
      <%= labeled_cell "Complications", complication_info, 6 %>
    </tr>
    </tbody>
</table>
<br>

<%= start_table "SpecialtyPatientSpinal" %>
    <thead>
    <%= start_row %>
      <%= heading "Specialty Patient &mdash; Spinal Immobilization" %>
    </tr>
    </thead>
    <tbody>
    <%= start_row %>
      <%= label "To Be Supplied" %>
    </tr>
    </tbody>
</table>
<br>

<%= start_table "Specialty Patient &mdash; Influenza Screening" %>
    <thead>
    <%= start_row %>
      <%= heading "Specialty Patient &mdash; Influenza Screening", 4 %>
    </tr>
    </thead>
    <tbody>
    <%= row 'E30_01', '' %>
    <%= start_row %>
    <%= labeled_cell_narrow "Symptoms", "" %>
    <%= labeled_cell "History", "" %>
    </tr>
    <%= row 'E30_03', 'E30_08' %>
    <%= row 'E30_04', 'E30_09' %>
    <%= row 'E30_05', 'E30_10' %>
    <%= row 'E30_06', 'E30_11' %>
    <%= row 'E30_07', '' %>
    <%= row 'E30_02', '' %>
    </tbody>
</table>
<br>

<%= start_table "SpecialtyPatientSAD" %>
    <thead>
    <%= start_row %>
      <%= heading "Specialty Patient &mdash; SAD (Psychiatric Ax)" %>
    </tr>
    </thead>
    <tbody>
    <%= start_row %>
      <%= label "To Be Supplied" %>
    </tr>
    </tbody>
</table>
<br>

<%= start_table "Incident Details" %>
  <thead>
  <%= start_row %>
    <%= heading "Incident Details", 2 %>
    <%= heading "Destination Details", 2 %>
    <%= heading "Incident Times", 2 %>
  </tr>
  </thead>
  <tbody>
  <%= start_row %>
    <%= labeled_cell "Location", @parser.E08_07 %>
    <%= labeled_cell "Disposition", @parser.concat('E20_10', 'E20_14') %>
    <%= labeled_cell "Call Received", @parser.parse_time('E05_01') %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "Address", @parser.E08_11 %>
    <%= labeled_cell "Transport Due To", @parser.E20_16 %>
    <%= labeled_cell "Dispatched", @parser.parse_time('E05_04') %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "Address 2", @parser.parse_value_of('IncidentAddress2') %>
    <%= labeled_cell "Transported To", @parser.E20_01 %>
    <%= labeled_cell "En Route", @parser.parse_time('E05_05') %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "City", @parser.E08_12 %>
    <%= labeled_cell "Requested By", @parser.parse_value_of('Requested By') %>
    <%= labeled_cell "Resp on Scene", @parser.parse_time('E05_06') %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "State", @parser.parse_state('E08_14') %>
    <%= labeled_cell "Destination", @parser.E20_17 %>
    <%= labeled_cell "On Scene", "" %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "Zip", @parser.E08_15 %>
    <%= labeled_cell "Address", @parser.E20_03 %>
    <%= labeled_cell "At Patient", @parser.parse_time('E05_07') %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "Medic Unit", @parser.E02_03 %>
    <%= labeled_cell "Address 2", @parser.parse_value_of('DestinationAddress2') %>
    <%= labeled_cell "Depart Scene", @parser.parse_time('E05_09') %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "Run Type", @parser.E02_04 %>
    <%= labeled_cell "City", @parser.E20_04 %>
    <%= labeled_cell "At Destination", @parser.parse_time('E05_10') %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "Priority Scene", @parser.E02_20 %>
    <%= labeled_cell "State", @parser.E20_05 %>
    <%= labeled_cell "Pt. Transferred", @parser.parse_time('E05_08') %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "Shift", @parser.parse_value_of('Shift') %>
    <%= labeled_cell "Zip", @parser.E20_07 %>
    <%= labeled_cell "Incident Close", @parser.parse_time('E05_11') %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "Zone", '' %>
    <%= labeled_cell "Zone", @parser.E20_09 %>
    <%= labeled_cell "In District", @parser.parse_time('E05_13') %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "Level of Service", @parser.parse_value_of('Level of Service') %>
    <%= labeled_cell "Condition at Destination", @parser.E20_15, 3 %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "Destination Record #", @parser.E12_03, 5 %>
  </tr>
  </tbody>
</table>
<br>
<%= start_table "Crew Members" %>
  <thead>
  <%= start_row %>
    <%= heading "Crew Members", 4 %>
  </tr>
  </thead>
  <tbody>
  <%= start_row %>
    <%= label_top "<b>Personnel</b>" %>
    <%= label_top "<b>Certification Number</b>" %>
    <%= label_top "<b>Role</b>" %>
    <%= label_top "<b>Certification Level</b>" %>
  </tr>
  <% @parser.parse_cluster('E04').each do |e04| %>
      <%= start_row %>
        <td></td>
        <%= cell (e04.E04_01) %>
        <%= cell (e04.E04_02) %>
        <%= cell (e04.E04_03) %>
      </tr>
  <% end %>
  </tbody>
</table>
<br>
<%= start_table "Insurance Details" %>
  <thead>
  <%= start_row %>
    <%= heading "Insurance Details", 8 %>
  </tr>
  </thead>
  <tbody>
  <%= start_row %>
    <%= labeled_cell "Insured's Name", (@parser.concat 'E07_11', 'E07_12', 'E07_13') %>
    <%= labeled_cell "State", "NC" %>
    <%= labeled_cell "Medicare", " " %>
    <%= labeled_cell "Secondary Ins", "&nbsp;" %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "Relationship to Patient", @parser.E07_14 %>
    <%= labeled_cell "Zip", " " %>
    <%= labeled_cell "Medicaid", " " %>
    <%= labeled_cell "Policy #", "" %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "Address 1", "&nbsp;" %>
    <%= labeled_cell "Country", " " %>
    <%= labeled_cell "Primary Insurance", @parser.E07_03 %>
    <%= labeled_cell "Group #", "" %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "Address 2", "&nbsp;" %>
    <%= labeled_cell "Phone", " " %>
    <%= labeled_cell "Group #", @parser.E07_09 %>
    <%= labeled_cell "Contact", " " %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "Address 3", "&nbsp;" %>
    <%= labeled_cell "Primary Payer", @parser.E07_01 %>
    <%= labeled_cell "Policy #", @parser.E07_10 %>
    <%= labeled_cell "Dispatch Nature", "&nbsp;" %>
  </tr>
  <%= start_row %>
    <%= labeled_cell "City", "Raleigh" %>
    <%= labeled_cell "Employer", @parser.E07_27 %>
    <%= labeled_cell "Job Related Injury", @parser.E07_15 %>
    <%= labeled_cell "Response Urgency", "&nbsp;" %>
  </tr>
  </tbody>
</table>
<br>
<%= start_table %>
  <tbody>
  <%= start_row %>
    <%= heading "Mileage" %>
    <%= labeled_cell "Scene", @parser.E02_17 %>
    <%= labeled_cell "Start", @parser.E02_16 %>
    <%= labeled_cell "Destination", @parser.E02_18 %>
    <%= labeled_cell "End", @parser.E02_19 %>
    <%= labeled_cell "Loaded Miles", @parser.E02_18.to_i - @parser.E02_17.to_i %>
    <%= labeled_cell "Total Miles", @parser.E02_19.to_i - @parser.E02_16.to_i %>
  </tr>
  </tbody>
</table>
<br>
<% additional_agencies = @parser.concat 'E08_01', 'E08_02'
   unless additional_agencies.empty?
%>
    <%= start_table %>
      <tbody>
      <%= start_row %>
        <%= heading "Additional Agencies" %>
        <%= cell (additional_agencies) %>
      </tr>
      </tbody>
    </table>
    <br>
<% end %>
<% delays = list_of_delays
   unless delays.empty?
%>
    <%= start_table "Delays" %>
      <thead>
      <%= start_row %>
        <%= heading "Delays", 2 %>
      </tr>
      </thead>
      <tbody>
      <%= list delays %>
      </tbody>
    </table>
    <br>
<% end %>

<% next_of_kin = concat_list [@parser.concat('E07_18', 'E07_19', 'E07_20'), @parser.E07_26, @parser.E07_25]
   next_of_kin_address = concat_list [@parser.E07_21, @parser.E07_22, @parser.E07_23]
   unless next_of_kin.empty? and next_of_kin_address.empty?
%>
<%= start_table "Next of Kin/Closest Relation/Guardian" %>
  <thead>
  <%= start_row %>
    <%= heading "Next of Kin/Closest Relation/Guardian", 2 %>
  </tr>
  </thead>
  <tbody>
  <%= start_row %>
    <%= labeled_cell_narrow "Next of Kin Name", next_of_kin %>
  </tr>
  <%= start_row %>
    <%= labeled_cell_narrow "Address", next_of_kin_address %>
  </tr>
  </tbody>
</table>
<br>
<% end %>

<%= start_table "Personal Items" %>
  <thead>
  <%= start_row %>
    <%= heading "Personal Items", 3 %>
  </tr>
  </thead>
  <tbody>
  <%= start_row %>
    <%= label "Item" %>
    <%= label "Given To" %>
    <%= label "Comment" %>
  </tr>
  <%= start_row %>
    <%= cell "TBD" %>
    <%= cell "TBD" %>
    <%= cell "TBD" %>
  </tr>
  </tbody>
</table>
<br>
<%= start_table "Transfer Details" %>
  <thead>
  <%= start_row %>
    <%= heading "Transfer Details", 4 %>
  </tr>
  </thead>
  <tbody>
  <%= start_row %>
    <%= labeled_cell_medium "PAN", "&nbsp;" %>
    <%= labeled_cell_medium "Sending Physician", "&nbsp;" %>
  </tr>
  <%= start_row %>
    <%= labeled_cell_medium "PCS", "&nbsp;" %>
    <%= labeled_cell_medium "Sending Record #", @parser.E12_02 %>
  </tr>
  <%= start_row %>
    <%= labeled_cell_medium "ABN", "&nbsp;" %>
    <%= labeled_cell_medium "Receiving Physician", "&nbsp;" %>
  </tr>
  <%= start_row %>
    <%= labeled_cell_medium "CMS Service Level", "&nbsp;" %>
    <%= labeled_cell_medium "Condition Code", "&nbsp;" %>
  </tr>
  <%= start_row %>
    <%= labeled_cell_medium "ICD-9 Code", "&nbsp;" %>
    <%= labeled_cell_medium "Condition Modifier Code", "&nbsp;" %>
  </tr>
  <%= start_row %>
    <%= labeled_cell_medium "Transfer Reason", "&nbsp;", 3 %>
  </tr>
  <%= start_row %>
    <%= labeled_cell_medium "Other/Services", "&nbsp;", 3 %>
  </tr>
  <%= start_row %>
    <%= labeled_cell_medium "Medical Necessity", "&nbsp;", 3 %>
  </tr>
  </tbody>
</table>
<br>


